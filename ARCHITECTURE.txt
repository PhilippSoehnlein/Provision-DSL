Grundideen zur Architektur.
---------------------------

not intended for publishing, therefore language is german, sorry.
nicht zum Weitergeben gedacht, daher in deutsch.



Bestandteile:
 (+: attribut, -: methode, *: Klasse, !: Rolle)

 * script                       enthält DSL Befehle
 * DSL                          pro DSL Befehl eine sub
 * App                          zentrale Ablaufsteuerung
    ----[ logging ]
    ----[ entity caching ]
    ----[ talked words ]
    ----[ command execution ]
 * Entity                       Basisklasse von Entities
    * Compound
        + children: Entity[]
        - add_child
        - nr_children
        - all_children
        - has_no_children
      * Dir                     Kinder: Dir, Rsync
          ! PathPermission
          ! PathOwner
          ! CheckDirExistence   --> evtl. in Klasse nehmen
          + path: Dir
          + mkdir: DirList
          + rmdir: DirList
          + content: ExistingDir
      * Perlbrew                Kinder: install, cpanm, perl, switch
          + install_cpanm: Bool
          + install_perl: Str
          + switch_to_perl: Str
      * _XXX::User              Kinder: Dir (=home), Group
          + uid: Int
          + home: Dir
          + group: Group
    * Execute
        + path: ExecutableFile
        + arguments: Str[]
        + environment: HashRef
    * File
        + path
        + content (Str <- Path, Url)
      Rollen: permission, owner
    * _XXX::Group
        + gid
    * _XXX::Package
    * Rsync
        + path: Dir
        + content: ExistingDir
        + exclude: DirList
    * _XXX::Service
 * Source                       Basisklasse von Datenquellen
      + name: Str
      + content: Str
    * Resource
        + root_dir: ExistingDir
        + path: File | Dir
      * Template
          + vars: HashRef
    * Url
        + url
[* Condition]



Entity Funktionsweise:

   * P::DSL::Entity
     ----[ identifikation, Wunsch ]
     + name                     Pflicht, wird evtl. nach ??? kopiert
     + app                      ->P::DSL::App
     + parent                   ->P::DSL::Entity, wenn compound
     + wanted                   bool oder Version [1]
     + talk                     auszusprechende Worte falls Änderung
     + ...                      weitere Angaben bei Kind-Klassen

     ----[ Bestimmen des Status ]
     + only_if / not_if         <-> is_ok, vorrangig
     + listen                   zu lauschende Worte
     - state                    missing / outdated / current
     - is_ok()                  wenn Endzustand "wanted" erreicht
                                normalerweise abgeleitet aus state/wanted

     ----[ Berechnete Werte ]
     + changed                  wird gesetzt, wenn Veränderung erfolgte

     ----[ Steuerung ]
     - execute()                auf Zustand "wanted" bringen
     - create()                 von Kindern zu erweitern, before!
     - change()                 von Kindern zu erweitern, before!
     - remove()                 von Kindern zu erweitern, after!
     - reloader()               -> coderef zum Reload



Entity Erweiterung:
  - über Rolle(n) oder Kind-Klassen
     * Entscheidung: (before|around|after) (is_ok)
     * Steuerung:    (before|after) (create|remove)
  - Aufruf-Reihenfolge:
     * Kind-Klassen, dann Kind-Rollen reverse (before, around)
     * Klasse, dann Rollen reverse (before, around)
     * Methode
     * Rollen, dann Klasse (around, after)
     * Kind-Rollen, dann Kind-Klasse (around, after)



Datenstruktur zum Deployment (gepackt als .tar.gz):

/
  apply.pl                  -- standard provision Datei
  bin/                      -- evtl. ein paar vorbereitete Binärdateien
    cpanm
    perlbrew
  etc/                      -- evtl. Konfigurations-Dateien
  lib/                      -- alle benötigten Bibliotheken
  resources/                -- Resource-Dateien



Vorbereitung eines Provision Vorganges:

 - auf dem Entwicklungs-Rechner
    * leeres Temp-Verzeichnis anlegen ($DIR)
    * via cpanm: Provision::DSL und Abhängigkeiten installieren
      dürfen nur Pure-Perl Module sein!
      --> derzeit ca. 50 pm-Dateien zuzüglich Provision::DSL
    * evtl. Konfigurations-Datei(en) nach $DIR/etc kopieren
    * Resourcen kopieren
    * .tar.gz erstellen
    
 - auf Ziel-Server kopieren
 
 - auf dem Ziel Server:
    * .tar.gz nach /tmp/whatever entpacken
    * cd /tmp/whatever
    * perl apply.pl ausführen


